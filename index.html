<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vue 3 + NeoVis Graph + LLM Chat (Starter)</title>
  <!-- TailwindCSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- vis-network for mock graph rendering (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.2/standalone/umd/vis-network.min.js"></script>
  <!-- NeoVis (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/neovis.js@2.0.2/dist/neovis.js"></script>
  <!-- Vue 3 (ESM) -->
  <script type="module">
    import { createApp, ref, reactive, computed, onMounted, watch, nextTick } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'

    // Utility: safe access to NeoVis across UMD variants
    function resolveNeoVis() {
      const g = window;
      return g.NeoVis?.NeoVis || g.NeoVis?.default || g.NeoVis || null;
    }

    // ----------------------------
    // Chat UI (LLM placeholder)
    // ----------------------------
    const ChatPanel = {
      name: 'ChatPanel',
      setup() {
        const messages = ref([
          { role: 'assistant', text: '안녕하세요! 그래프에서 궁금한 걸 물어보세요 😊' }
        ])
        const input = ref('노드 간 연결 규칙을 요약해줘 (예시)')

        const send = () => {
          const text = input.value.trim()
          if (!text) return
          messages.value.push({ role: 'user', text })
          // Placeholder response (UI only). Replace with real API call later.
          setTimeout(() => {
            messages.value.push({
              role: 'assistant',
              text: '응답 예시: 해당 질문은 백엔드 LLM API와 연동하면 실제 답변으로 대체됩니다.'
            })
          }, 300)
          input.value = ''
        }

        const handleKey = (e) => {
          if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') send()
        }

        return { messages, input, send, handleKey }
      },
      template: `
        <div class="flex flex-col h-full">
          <div class="flex-1 overflow-y-auto space-y-3 p-3 rounded-2xl bg-white shadow-inner">
            <div v-for="(m, idx) in messages" :key="idx" class="flex" :class="m.role==='user' ? 'justify-end' : 'justify-start'">
              <div :class="[
                  'max-w-[80%] px-4 py-2 rounded-2xl shadow',
                  m.role==='user' ? 'bg-blue-600 text-white rounded-br-sm' : 'bg-gray-100 text-gray-900 rounded-bl-sm'
                ]">
                {{ m.text }}
              </div>
            </div>
          </div>
          <div class="mt-3 flex gap-2">
            <textarea v-model="input" @keydown="handleKey" rows="2" placeholder="메시지를 입력하고 Ctrl/⌘+Enter로 전송"
              class="flex-1 resize-none rounded-2xl border border-gray-300 p-3 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow"></textarea>
            <button @click="send" class="px-5 py-2 rounded-2xl bg-blue-600 text-white shadow hover:bg-blue-700 transition">보내기</button>
          </div>
        </div>
      `
    }

    // ----------------------------
    // Graph Panel (Mock + NeoVis)
    // ----------------------------
    const GraphPanel = {
      name: 'GraphPanel',
      props: { height: { type: String, default: '540px' } },
      setup(props) {
        const container = ref(null)
        const network = ref(null) // vis-network instance for mock
        const viz = ref(null)     // NeoVis instance for real backend

        // UI state
        const mode = ref('mock') // 'mock' | 'neovis'
        const physics = ref(true)
        const hierarchical = ref(false)
        const status = ref('ready')

        // Neo4j connection (used when mode === 'neovis')
        const neo4j = reactive({
          url: 'bolt://localhost:7687',
          user: 'neo4j',
          password: 'password',
          database: 'neo4j',
          initialCypher: 'MATCH (n)-[r]->(m) RETURN n,r,m LIMIT 50'
        })

        // Mock ontology data (replace with backend later)
        const mockData = reactive({
          nodes: [
            { id: 'p1', label: 'Person\nAlice', group: 'Person' },
            { id: 'p2', label: 'Person\nBob', group: 'Person' },
            { id: 'c1', label: 'Company\nAcme Corp', group: 'Company' },
            { id: 't1', label: 'Tech\nNeo4j', group: 'Technology' },
            { id: 't2', label: 'Tech\nVue.js', group: 'Technology' },
            { id: 'o1', label: 'Ontology\nGraph', group: 'Concept' },
          ],
          edges: [
            { id: 'e1', from: 'p1', to: 'c1', label: 'WORKS_AT' },
            { id: 'e2', from: 'p2', to: 'c1', label: 'WORKS_AT' },
            { id: 'e3', from: 'c1', to: 't1', label: 'USES' },
            { id: 'e4', from: 'c1', to: 't2', label: 'USES' },
            { id: 'e5', from: 't1', to: 'o1', label: 'MODELS' },
            { id: 'e6', from: 't2', to: 'o1', label: 'VISUALIZES' },
          ]
        })

        const visOptions = computed(() => ({
          physics: { enabled: physics.value, stabilization: { iterations: 120 } },
          layout: hierarchical.value ? { hierarchical: { direction: 'LR', sortMethod: 'directed', levelSeparation: 150 } } : {},
          interaction: { hover: true, tooltipDelay: 120 },
          nodes: {
            shape: 'box', borderWidth: 1, margin: 8,
            font: { multi: 'md', face: 'ui-sans-serif, system-ui', size: 12 }
          },
          edges: { arrows: 'to', smooth: { type: 'dynamic' }, font: { size: 10, align: 'top' } }
        }))

        const renderMock = async () => {
          status.value = 'rendering'
          await nextTick()
          const data = {
            nodes: new vis.DataSet(mockData.nodes),
            edges: new vis.DataSet(mockData.edges)
          }
          if (network.value) network.value.destroy()
          network.value = new vis.Network(container.value, data, visOptions.value)
          network.value.once('stabilized', () => { status.value = 'ready' })
        }

        const renderNeoVis = async () => {
          const NeoVisClass = resolveNeoVis()
          if (!NeoVisClass) {
            console.warn('NeoVis library not detected. Check CDN script tag.')
            status.value = 'error'
            return
          }
          status.value = 'connecting'
          await nextTick()

          // Destroy mock network if exists
          if (network.value) { network.value.destroy(); network.value = null }
          if (viz.value) { try { viz.value.clearNetwork() } catch(_){} viz.value = null }

          const config = {
            containerId: container.value.id,
            neo4j: {
              serverUrl: neo4j.url,
              serverUser: neo4j.user,
              serverPassword: neo4j.password,
              database: neo4j.database
            },
            labels: {
              Person: { caption: 'name' },
              Company: { caption: 'name' },
              Technology: { caption: 'name' },
              Concept: { caption: 'name' },
            },
            relationships: {
              WORKS_AT: { caption: true },
              USES: { caption: true },
              MODELS: { caption: true },
              VISUALIZES: { caption: true },
            },
            visConfig: visOptions.value,
            initialCypher: neo4j.initialCypher
          }

          try {
            viz.value = new NeoVisClass(config)
            viz.value.render()
            status.value = 'ready'
          } catch (err) {
            console.error(err)
            status.value = 'error'
          }
        }

        onMounted(async () => {
          await renderMock()
        })

        watch([physics, hierarchical], async () => {
          if (mode.value === 'mock') await renderMock()
          else await renderNeoVis()
        })

        const switchMode = async (m) => {
          mode.value = m
          if (m === 'mock') await renderMock()
          else await renderNeoVis()
        }

        const fit = () => {
          if (mode.value === 'mock' && network.value) network.value.fit({ animation: true })
          // NeoVis exposes underlying vis via viz._network
          if (mode.value === 'neovis' && viz.value && viz.value._network) viz.value._network.fit({ animation: true })
        }

        return { container, mode, physics, hierarchical, status, switchMode, neo4j, fit }
      },
      template: `
        <div class="space-y-3">
          <div class="flex flex-wrap items-center gap-2">
            <div class="inline-flex bg-white rounded-2xl shadow overflow-hidden">
              <button @click="switchMode('mock')" :class="['px-3 py-2', mode==='mock' ? 'bg-gray-900 text-white' : 'text-gray-700']">Mock</button>
              <button @click="switchMode('neovis')" :class="['px-3 py-2', mode==='neovis' ? 'bg-gray-900 text-white' : 'text-gray-700']">Neo4j (NeoVis)</button>
            </div>
            <label class="inline-flex items-center gap-2 bg-white px-3 py-2 rounded-2xl shadow">
              <input type="checkbox" v-model="physics" class="rounded">
              <span class="text-sm">Physics</span>
            </label>
            <label class="inline-flex items-center gap-2 bg-white px-3 py-2 rounded-2xl shadow">
              <input type="checkbox" v-model="hierarchical" class="rounded">
              <span class="text-sm">Hierarchical</span>
            </label>
            <button @click="fit" class="px-3 py-2 rounded-2xl bg-white shadow hover:bg-gray-50">Fit</button>
            <span class="text-sm text-gray-500">Status: {{ status }}</span>
          </div>

          <div v-if="mode==='neovis'" class="grid md:grid-cols-5 gap-2 bg-white p-3 rounded-2xl shadow">
            <input v-model="neo4j.url" placeholder="bolt://host:7687" class="md:col-span-2 rounded-xl border p-2" />
            <input v-model="neo4j.user" placeholder="neo4j" class="rounded-xl border p-2" />
            <input v-model="neo4j.password" placeholder="password" type="password" class="rounded-xl border p-2" />
            <input v-model="neo4j.database" placeholder="neo4j" class="rounded-xl border p-2" />
            <input v-model="neo4j.initialCypher" placeholder="MATCH (n)-[r]->(m) RETURN n,r,m LIMIT 50" class="md:col-span-4 rounded-xl border p-2" />
            <button @click="switchMode('neovis')" class="md:col-span-1 px-3 py-2 rounded-xl bg-blue-600 text-white shadow hover:bg-blue-700">Connect</button>
          </div>

          <div :style="{height: height}" class="bg-white rounded-2xl shadow relative">
            <div :id="'graph-container'" ref="container" class="absolute inset-0 rounded-2xl"></div>
          </div>
        </div>
      `
    }

    // ----------------------------
    // Root App
    // ----------------------------
    const App = {
      components: { ChatPanel, GraphPanel },
      setup() {
        const sidebarOpen = ref(true)
        return { sidebarOpen }
      },
      template: `
        <div class="min-h-screen bg-gray-100">
          <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b">
            <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
              <h1 class="text-xl font-semibold tracking-tight">Neo4j Graph + LLM Chat (Vue 3 + Tailwind)</h1>
              <button @click="sidebarOpen=!sidebarOpen" class="px-3 py-2 rounded-2xl bg-gray-900 text-white shadow">Toggle Chat</button>
            </div>
          </header>

          <main class="max-w-7xl mx-auto p-4 grid lg:grid-cols-3 gap-4">
            <section class="lg:col-span-2 space-y-4">
              <div class="p-4 bg-white rounded-2xl shadow">
                <h2 class="text-lg font-semibold mb-3">그래프 탐색</h2>
                <GraphPanel height="560px" />
              </div>
            </section>

            <aside v-show="sidebarOpen" class="lg:col-span-1 p-4 bg-white rounded-2xl shadow h-fit lg:sticky lg:top-20">
              <h2 class="text-lg font-semibold mb-3">LLM 채팅 (UI만)</h2>
              <ChatPanel />
            </aside>
          </main>

          <footer class="max-w-7xl mx-auto px-4 py-6 text-sm text-gray-500">
            <p>🧩 교체 포인트: 실제 백엔드 연결 시 GraphPanel에서 <code>mode='neovis'</code>와 Neo4j 접속 정보를 사용하세요. 채팅은 백엔드 API 호출로 대체.</p>
          </footer>
        </div>
      `
    }

    createApp(App).mount('#app')
  </script>
</head>
<body class="antialiased">
  <div id="app"></div>
</body>
</html>
